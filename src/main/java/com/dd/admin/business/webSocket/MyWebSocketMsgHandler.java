package com.dd.admin.business.webSocket;import com.alibaba.fastjson.JSON;import com.dd.admin.common.utils.AddressUtils;import com.dd.admin.common.utils.IPUtils;import com.dd.admin.common.utils.StringUtil;import lombok.extern.slf4j.Slf4j;import org.slf4j.Logger;import org.slf4j.LoggerFactory;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.context.annotation.Configuration;import org.springframework.context.annotation.Primary;import org.springframework.stereotype.Component;import org.tio.core.ChannelContext;import org.tio.core.Tio;import org.tio.http.common.HttpRequest;import org.tio.http.common.HttpResponse;import org.tio.utils.lock.SetWithLock;import org.tio.websocket.common.WsRequest;import org.tio.websocket.server.handler.IWsMsgHandler;import org.tio.websocket.starter.TioWebSocketServerBootstrap;import javax.annotation.PostConstruct;import javax.servlet.http.HttpServletRequest;import java.util.HashMap;import java.util.Map;import java.util.Set;@Configuration@Slf4jpublic class MyWebSocketMsgHandler implements IWsMsgHandler {    @Autowired    Map<String, MsgHandlerInterface> handlerInterfaceMap;    @Override    public HttpResponse handshake(HttpRequest request, HttpResponse httpResponse, ChannelContext channelContext) throws Exception {        String authorId = request.getParam("authorId");        String authorName = request.getParam("authorName");        Tio.bindUser(channelContext,authorId);        String ipAddr = request.getClientIp();        String realAddress = AddressUtils.getRealAddress(ipAddr);        System.out.println(authorId+"：进入了Tio id："+authorId+" ip："+ ipAddr);        SetWithLock<ChannelContext> channelContexts =  Tio.getAllChannelContexts(channelContext.getGroupContext());        Set<ChannelContext> contextList = channelContexts.getObj();        System.out.println("当前在线用户:");        for(ChannelContext context:contextList){            System.out.println(context.userid+"\t");        }       Integer count = channelContexts.size();        System.out.println("当前共"+count+"个用户");        return httpResponse;    }    @Override    public void onAfterHandshaked(HttpRequest httpRequest, HttpResponse httpResponse, ChannelContext channelContext) throws Exception {//        System.out.println("握手成功进入群组");    }    @Override    public Object onBytes(WsRequest wsRequest, byte[] bytes, ChannelContext channelContext) throws Exception {        System.out.println("接收到bytes消息");        return null;    }    @Override    public Object onClose(WsRequest wsRequest, byte[] bytes, ChannelContext channelContext) throws Exception {        return null;    }    @Override    public Object onText(WsRequest wsRequest, String text, ChannelContext channelContext) throws Exception {        if(text.equals("ping")) return "pong";        System.out.println("接收到文本消息："+text);        Map map = JSON.parseObject(text,Map.class);        String handlerType =(String)map.get("handlerType");        if(!StringUtil.isEmpty(handlerType)){            MsgHandlerInterface msgHandler = (MsgHandlerInterface) handlerInterfaceMap.get(handlerType);            if(msgHandler!=null){                msgHandler.handler(map,channelContext);            }else{                log.debug("非法请求...");            }        }else{            log.debug("非法请求...");        }        System.out.println(map);        return null;    }}